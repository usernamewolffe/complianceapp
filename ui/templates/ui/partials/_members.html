{# ui/templates/ui/partials/_members.html #}
<div id="members-block">

  {# Flash banner (swapped with the block) #}
  {% if error %}
    <div class="flash error" role="alert"
         style="margin:0 0 .75rem;padding:.5rem .75rem;border:1px solid #f1aeb5;background:#f8d7da;border-radius:.5rem;color:#842029">
      {{ error }}
    </div>
  {% elif ok %}
    <div class="flash ok" role="status"
         style="margin:0 0 .75rem;padding:.5rem .75rem;border:1px solid #a3cfbb;background:#d1e7dd;border-radius:.5rem;color:#0f5132">
      Saved.
    </div>
  {% endif %}

  <table>
    <thead>
      <tr>
        <th>Member</th>
        <th>Role</th>
        <th>Joined</th>
        <th class="right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for m in members %}
        <tr>
          <td>
            {{ m.user.get_full_name|default:m.user.username|default:m.user.email }}
            {% if m.user.email and m.user.get_full_name %}
              <span class="muted">({{ m.user.email }})</span>
            {% endif %}
          </td>

          <td>
            {% if acting_role == "owner" %}
              <form
                hx-post="{% url 'orgs:org-member-update' org.id m.id %}"
                hx-target="#members-block"
                hx-swap="outerHTML"
                hx-disabled-elt="select">
                {% csrf_token %}
                <select name="role" onchange="this.form.requestSubmit()"
                        style="padding:.35rem .5rem;border:1px solid #ced4da;border-radius:.4rem">
                  {% for value,label in roles %}
                    <option value="{{ value }}" {% if m.role == value %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </form>
            {% else %}
              {{ m.get_role_display }}
            {% endif %}
          </td>

          <td>{{ m.accepted_at|date:"Y-m-d H:i" }}</td>

          <td class="right">
            {% if acting_role == "owner" %}
              {% if m.user_id == request.user.id %}
                <span class="muted">This is you</span>
              {% else %}
                <form
                  hx-post="{% url 'orgs:org-member-toggle' org.id m.id %}"
                  hx-target="#members-block"
                  hx-swap="outerHTML"
                  hx-disabled-elt="button"
                  {% if m.is_active %}
                    hx-confirm="Deactivate {{ m.user.get_full_name|default:m.user.username|default:m.user.email }}? They will immediately lose access."
                  {% else %}
                    hx-confirm="Reactivate {{ m.user.get_full_name|default:m.user.username|default:m.user.email }}?"
                  {% endif %}
                  style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="active" value="{% if m.is_active %}false{% else %}true{% endif %}">
                  <button class="btn">{% if m.is_active %}Deactivate{% else %}Reactivate{% endif %}</button>
                </form>
              {% endif %}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 style="margin-top:1rem">Invitations</h3>
  {% if invitations %}
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Role</th>
          <th>Expires</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invitations %}
          <tr>
            <td>{{ inv.email }}</td>
            <td>{{ inv.get_role_display }}</td>
            <td>{{ inv.expires_at|date:"Y-m-d H:i" }}</td>
            <td class="right">
              {% if inv.used_at or inv.cancelled_at %}
                <span class="muted">—</span>
              {% else %}
                <form
                  hx-post="{% url 'orgs:invitation-cancel' org.id inv.id %}"
                  hx-target="#members-block"
                  hx-swap="outerHTML"
                  hx-disabled-elt="button"
                  onsubmit="return confirm('Cancel this invitation to {{ inv.email }}?')"
                  style="display:inline">
                  {% csrf_token %}
                  <button class="btn btn-outline">Cancel</button>
                </form>
                <form
                  hx-post="{% url 'orgs:invitation-resend' org.id inv.id %}"
                  hx-target="#members-block"
                  hx-swap="outerHTML"
                  hx-disabled-elt="button"
                  style="display:inline">
                  {% csrf_token %}
                  <button class="btn">Resend</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted" style="margin-bottom:.5rem">No pending invitations.</div>
  {% endif %}

  {% if acting_role == "owner" or acting_role == "admin" %}
    <form
      hx-post="{% url 'orgs:org-invite-create' org.id %}"
      hx-target="#members-block"
      hx-swap="outerHTML"
      hx-disabled-elt="button"
      style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.5rem">
      {% csrf_token %}
      <input type="email" name="email" placeholder="name@example.com"
             required style="flex:1;min-width:240px;padding:.5rem;border:1px solid #ced4da;border-radius:.5rem" />
      <select name="role" style="padding:.5rem;border:1px solid #ced4da;border-radius:.5rem">
        {% for value,label in roles %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn" type="submit">Send invitation</button>
    </form>
  {% endif %}

</div>
