{# expects: org, site (optional), incidents=[{"obj": Incident, ...}], container_id (optional) #}
{% with dom_prefix=container_id|default:'incidents-block' %}
<div id="{{ dom_prefix }}" data-incidents-host>

  <style>
    /* Hide panels until content is loaded */
    .inc-panel__content:empty { display: none; }
    .inc-panel {
      margin: .5rem 0;
      border: 1px solid #e9ecef;
      border-radius: .5rem;
      padding: .5rem .75rem;
      background: #fff;
    }
  </style>

  {% if incidents %}
    <table>
      <thead>
        <tr>
          <th scope="col">Title</th>
          <th scope="col">Status</th>
          <th scope="col">72-hour deadline</th>
        </tr>
      </thead>
      <tbody>
        {% for it in incidents %}
          {% with inc=it.obj %}
            {# Main row #}
            <tr id="{{ dom_prefix }}-inc-{{ inc.id }}-row">
              {# TITLE (includes Edit / Notes / Files buttons) #}
              {% include "ui/partials/_title_cell.html" with org_id=org.id inc=inc dom_prefix=dom_prefix %}

              {# STATUS (green “Reported”, modal + buttons, etc.) #}
              {% include "ui/partials/_status_cell.html" with incident=inc org_id=org.id dom_prefix=dom_prefix %}

              {# DEADLINE (use what you already had; swap to your timer partial if you like) #}
              <td>
                {% if inc.deadline_at %}{{ inc.deadline_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}
              </td>
            </tr>

            {# PANELS ROW: targets for the Notes/Files buttons #}
            <tr id="{{ dom_prefix }}-inc-{{ inc.id }}-panels">
              <td colspan="3">
                <div id="{{ dom_prefix }}-inc-{{ inc.id }}-notes" class="inc-panel">
                  <div id="{{ dom_prefix }}-inc-{{ inc.id }}-notes-content" class="inc-panel__content"></div>
                </div>
                <div id="{{ dom_prefix }}-inc-{{ inc.id }}-files" class="inc-panel">
                  <div id="{{ dom_prefix }}-inc-{{ inc.id }}-files-content" class="inc-panel__content"></div>
                </div>
              </td>
            </tr>
          {% endwith %}
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted">No incidents.</div>
  {% endif %}

  {# New incident form (only when rendering for a specific site) #}
  {% if site %}
    <form id="add-incident-form"
          hx-post="{% url 'incidents:create' org_id=org.id site_id=site.id %}"
          hx-target="#{{ dom_prefix }}"
          hx-swap="outerHTML"
          hx-disabled-elt="button"
          style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem">
      {% csrf_token %}
      <input name="title" placeholder="Incident title" style="flex:1;min-width:220px" />
      <button class="btn" type="submit">Add incident</button>
    </form>
  {% endif %}
</div>
{% endwith %}
