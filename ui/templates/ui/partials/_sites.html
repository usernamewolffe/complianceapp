{# ui/templates/ui/partials/_sites.html #}
<div id="sites-block">
  {% if sites %}
    <table>
      <thead>
        <tr>
          <th scope="col">Site</th>
          {% if can_manage_sites %}
            <th scope="col" style="width:1%">Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in sites %}
          <tr>
            <td>
              <div class="site-name">{{ s.name }}</div>

              <div id="site-{{ s.id }}-incidents"
                   hx-get="{% url 'incidents:site-incidents-block' org_id=org.id site_id=s.id %}"
                   hx-vals='{"container_id":"site-{{ s.id }}-incidents"}'
                   hx-trigger="load"
                   hx-target="#site-{{ s.id }}-incidents"
                   hx-swap="outerHTML">
                Loading incidents…
              </div>
            </td>

            {% if can_manage_sites %}
              <td style="white-space:nowrap; text-align:right">
                {# --- EITHER: open edit modal (HTMX) --- #}
                <a class="btn"
                   hx-get="{% url 'orgs:site-edit' org_id=org.id site_id=s.id %}"
                   hx-target="body"
                   hx-swap="beforeend">Edit</a>

                {# --- OR: normal page nav with return (remove if using modal) --- #}
                {# <a class="btn"
                      href="{% url 'orgs:site-edit' org_id=org.id site_id=s.id %}?next=/orgs/{{ org.id }}/">
                     Edit
                   </a> #}

                {# Safe delete: POST + hx-confirm + CSRF, swaps the whole sites block #}
                <form
                  hx-post="{% url 'orgs:site-delete' org_id=org.id site_id=s.id %}"
                  hx-target="#sites-block"
                  hx-swap="outerHTML"
                  hx-confirm="Delete '{{ s.name }}'? This cannot be undone."
                  style="display:inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Delete site</button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted">No sites yet.</div>
  {% endif %}

  {% if can_manage_sites %}
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.75rem">
      <button class="btn" type="button"
              hx-get="{% url 'orgs:site-create' org.id %}"
              hx-target="#site-create-modal-content"
              hx-swap="innerHTML"
              onclick="document.getElementById('site-create-modal').showModal()">
        Add site
      </button>
    </div>

    {# Modal shell for Create; content loaded via HX #}
    <dialog id="site-create-modal" class="c-modal" aria-labelledby="site-create-title">
      <div class="c-modal__card" style="max-width:820px;width:90vw">
        <div class="c-modal__header" style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:12px 16px">
          <h3 id="site-create-title" class="c-modal__title" style="margin:0;font-size:1.1rem">Add site</h3>
          <button type="button" class="c-modal__x" onclick="this.closest('dialog').close()" style="background:none;border:none;font-size:1.25rem;cursor:pointer">×</button>
        </div>
        <div id="site-create-modal-content" style="padding:12px 16px">Loading…</div>
      </div>
      <style>
        .c-modal { border: none; border-radius: 12px; padding: 0; }
        .c-modal::backdrop { background: rgba(0,0,0,.35); }
      </style>
      <script>
        (function(dlg){
          if (!dlg) return;
          dlg.addEventListener('close', () => dlg.removeAttribute('open'));
        })(document.getElementById('site-create-modal'));
      </script>
    </dialog>
  {% endif %}
</div>
