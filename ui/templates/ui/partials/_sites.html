{# ui/templates/ui/partials/_sites.html #}
<div id="sites-block">
  {% if sites %}
    <table>
      <thead>
        <tr>
          <th scope="col">Site</th>
          {% if can_manage_sites %}
            <th scope="col" style="width:1%">Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in sites %}
          <tr>
            <td>
              <div class="site-name">{{ s.name }}</div>

              <div id="site-{{ s.id }}-incidents"
                   hx-get="{% url 'incidents:site-incidents-block' org_id=org.id site_id=s.id %}"
                   hx-vals='{"container_id":"site-{{ s.id }}-incidents"}'
                   hx-trigger="load"
                   hx-target="#site-{{ s.id }}-incidents"
                   hx-swap="outerHTML">
                Loading incidents…
              </div>
            </td>

            {% if can_manage_sites %}
              <td style="white-space:nowrap; text-align:right">
                <a class="btn"
                   hx-get="{% url 'orgs:site-edit' org_id=org.id site_id=s.id %}"
                   hx-target="body"
                   hx-swap="beforeend">Edit</a>

                <form
                  hx-post="{% url 'orgs:site-delete' org_id=org.id site_id=s.id %}"
                  hx-target="#sites-block"
                  hx-swap="outerHTML"
                  hx-confirm="Delete '{{ s.name }}'? This cannot be undone."
                  style="display:inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Delete site</button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted">No sites yet.</div>
  {% endif %}

  {% if can_manage_sites %}
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.75rem">
      {# Add site button #}
      <button class="btn"
              type="button"
              id="open-site-create"
              data-url="{% url 'orgs:site-create' org_id=org.id %}">
        Add site
      </button>
    </div>

    {# --- Single modal shell (keep exactly one of these on the page) --- #}
    <dialog id="site-create-modal"
            style="width:96vw;height:92vh;max-width:none;margin:0;padding:0;background:#fff;border:0;border-radius:12px">
      <div style="width:100%;height:100%;display:flex;flex-direction:column;background:#fff">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:12px 16px">
          <h3 style="margin:0;font-size:1.1rem">Add site</h3>
          <button type="button"
                  onclick="document.getElementById('site-create-modal').close()"
                  style="background:none;border:none;font-size:1.25rem;cursor:pointer">×</button>
        </div>
        <div id="site-create-modal-content" style="flex:1 1 auto;overflow:auto;padding:16px 20px">Loading…</div>
      </div>
    </dialog>

    <style>
      #site-create-modal::backdrop { background: rgba(0,0,0,.35); }
      /* Make any injected content stretch */
      #site-create-modal .c-modal__card,
      #site-create-modal form,
      #site-create-modal .container,
      #site-create-modal .panel,
      #site-create-modal .card,
      #site-create-modal .wrapper {
        max-width:none !important; width:100% !important; height:100% !important;
      }
    </style>

    <script>
      // Open the modal and load the form
      document.addEventListener('click', function (e) {
        if (e.target && e.target.id === 'open-site-create') {
          const dlg = document.getElementById('site-create-modal');
          if (!dlg) return;
          (dlg.showModal ? dlg.showModal() : dlg.setAttribute('open','open'));
          const url = e.target.getAttribute('data-url');
          if (window.htmx) {
            htmx.ajax('GET', url, { target: '#site-create-modal-content', swap: 'innerHTML' });
          } else {
            fetch(url).then(r => r.text()).then(html => {
              document.getElementById('site-create-modal-content').innerHTML = html;
            });
          }
        }
      });

      // Close the modal after sites list refreshes
      document.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail?.target?.id === 'sites-block') {
          document.getElementById('site-create-modal')?.close();
        }
      });
    </script>
  {% endif %}
</div>
